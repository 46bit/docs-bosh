# Rotating NATS Certificates

The following strategy rotates the certificates and CA across the director, health monitor, NATS, and all VMs. See [Components of Bosh](bosh-components.md) for more information on core components.


![image](images/nats_rotation.png)

#### Preconditions:

* Director is in a healthy state.
* All VMs are in `running` state in all deployments.


### Redeploy the director, health monitor, and NATS, with a new CA.

```shell

$ bosh create-env ~/workspace/bosh-deployment/bosh.yml \
 --state ./state.json \
 -o ~/workspace/bosh-deployment/[IAAS]/cpi.yml \
 -o add-new-ca.yml \
 -o ... additional opsfiles \
 --vars-store ./creds.yml \
 -v ... additional vars
```

* Adds new variables for the new CA/certificates/private_key. 
* The director and health monitor are given a modified CA with the original CA and the new CA concatenated as `((nats_server_tls.ca))((nats_server_tls_2.ca))`. This allows the director to communicate with NATS using new certificates, while NATS can still communicate with the director.[1](#limitations).
* The director and health monitor are updated to use certificates and keys generated by the new CA.
* NATS continues to use the old certificates and private key. NATS is given the concatenated CA from above to verify certificate generated using new CA and old CA. 
* Each VM/agent continues to use the old certificates to communicate with NATS. 
* 

`add-new-ca.yml` 

```yaml
---
- type: replace
  path: /instance_groups/name=bosh/properties/nats/tls/ca?
  value: ((nats_server_tls.ca))((nats_server_tls_2.ca))

- type: replace
  path: /instance_groups/name=bosh/properties/nats/tls/client_ca?
  value:
    certificate: ((nats_ca_2.certificate))
    private_key: ((nats_ca_2.private_key))

- type: replace
  path: /instance_groups/name=bosh/properties/nats/tls/director?
  value:
    certificate: ((nats_clients_director_tls_2.certificate))
    private_key: ((nats_clients_director_tls_2.private_key))

- type: replace
  path: /instance_groups/name=bosh/properties/nats/tls/health_monitor?
  value:
    certificate: ((nats_clients_health_monitor_tls_2.certificate))
    private_key: ((nats_clients_health_monitor_tls_2.private_key))

- type: replace
  path: /variables/-
  value:
    name: nats_ca_2
    type: certificate
    options:
      is_ca: true
      common_name: default.nats-ca.bosh-internal

- type: replace
  path: /variables/-
  value:
    name: nats_server_tls_2
    type: certificate
    options:
      ca: nats_ca_2
      common_name: default.nats.bosh-internal
      alternative_names: [((internal_ip))]
      extended_key_usage:
      - server_auth

- type: replace
  path: /variables/-
  value:
    name: nats_clients_director_tls_2
    type: certificate
    options:
      ca: nats_ca_2
      common_name: default.director.bosh-internal
      extended_key_usage:
      - client_auth

- type: replace
  path: /variables/-
  value:
    name: nats_clients_health_monitor_tls_2
    type: certificate
    options:
      ca: nats_ca_2
      common_name: default.hm.bosh-internal
      extended_key_usage:
      - client_auth

```

### Recreate all VMs, for each deployment.

```shell
$ bosh -d deployment-name recreate
```

Each VM will receive a certificate and private key generated with the new CA from the director. The director uses the value of `client_ca` to generate the certificates. 


### Redeploy the director, health monitor, and NATS, to remove the old CA.

```shell
$ bosh create-env ~/workspace/bosh-deployment/bosh.yml \
 --state ./state.json \
 -o ~/workspace/bosh-deployment/[IAAS]/cpi.yml \
 -o remove-old-ca.yml \
 -o ... additional opsfiles \
 --vars-store ./creds.yml \
 -v ... additional vars
```

`remove-old-ca.yml`

* `nats.tls.ca` is updated to remove the old CA from the concatenated CAs. 
* The director and health monitor continue to use only new certificates. The CA is updated to be just the new CA.
* The NATS server is updated to use a new certificate and private key, generated by the new CA.
* All components can communicate using the new CA.

```yaml
---
- type: replace
  path: /instance_groups/name=bosh/properties/nats/tls/ca?
  value: ((nats_server_tls_2.ca))

- type: replace
  path: /instance_groups/name=bosh/properties/nats/tls/server?
  value:
    certificate: ((nats_server_tls_2.certificate))
    private_key: ((nats_server_tls_2.private_key))

- type: replace
  path: /instance_groups/name=bosh/properties/nats/tls/client_ca?
  value:
    certificate: ((nats_ca_2.certificate))
    private_key: ((nats_ca_2.private_key))

- type: replace
  path: /instance_groups/name=bosh/properties/nats/tls/director?
  value:
    certificate: ((nats_clients_director_tls_2.certificate))
    private_key: ((nats_clients_director_tls_2.private_key))

- type: replace
  path: /instance_groups/name=bosh/properties/nats/tls/health_monitor?
  value:
    certificate: ((nats_clients_health_monitor_tls_2.certificate))
    private_key: ((nats_clients_health_monitor_tls_2.private_key))

- type: replace
  path: /variables/-
  value:
    name: nats_ca_2
    type: certificate
    options:
      is_ca: true
      common_name: default.nats-ca.bosh-internal

- type: replace
  path: /variables/-
  value:
    name: nats_server_tls_2
    type: certificate
    options:
      ca: nats_ca_2
      common_name: default.nats.bosh-internal
      alternative_names: [((internal_ip))]
      extended_key_usage:
      - server_auth

- type: replace
  path: /variables/-
  value:
    name: nats_clients_director_tls_2
    type: certificate
    options:
      ca: nats_ca_2
      common_name: default.director.bosh-internal
      extended_key_usage:
      - client_auth

- type: replace
  path: /variables/-
  value:
    name: nats_clients_health_monitor_tls_2
    type: certificate
    options:
      ca: nats_ca_2
      common_name: default.hm.bosh-internal
      extended_key_usage:
      - client_auth

```


### Recreate all VMs, for each deployment.
```shell
$ bosh -d deployment-name recreate
```

### Limitations

A dependency within the director and health monitor lacks the ability to verify against multiple CAs. For this reason, we specifically concatenate old_ca + new_ca. Only the first is considered for verification. mTLS between the director and NATS will fail when new_ca + old_ca, as the new_ca will only be considered for verification against the old certs NATS sends the director/HM. 